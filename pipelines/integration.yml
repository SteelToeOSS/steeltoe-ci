---
resource_types:
- name: cf-space-resource
  type: docker-image
  source:
    repository: dgodd/cf-space-resource

resources:
- name: steeltoe-ci
  type: git
  source:
    uri: https://github.com/SteelToeOSS/steeltoe-ci.git
    branch: ci-music
- name: samples-rabbit
  type: git
  source:
    uri: https://github.com/SteelToeOSS/Samples.git
    path: Connectors/src/Rabbit/
    branch: dev
- name: samples-postgresql
  type: git
  source:
    uri: https://github.com/SteelToeOSS/Samples.git
    path: Connectors/src/PostgreSql/
    branch: dev
- name: samples-mysql-ef6
  type: git
  source:
    uri: https://github.com/SteelToeOSS/Samples.git
    path: Connectors/src/MySqlEF6/
    branch: dev
- name: samples-caching
  type: git
  source:
    uri: https://github.com/SteelToeOSS/Samples.git
    path: Caching/src/RedisCloudFoundry/
    branch: dev
- name: samples-config
  type: git
  source:
    uri: https://github.com/SteelToeOSS/Samples.git
    path: Configuration/src/AspDotNetCore/SimpleCloudFoundry
    branch: dev
- name: samples-mysql
  type: git
  source:
    uri: https://github.com/SteelToeOSS/Samples.git
    path: Connectors/src/MySql/
    branch: dev
- name: samples-oauth
  type: git
  source:
    uri: https://github.com/SteelToeOSS/Samples.git
    path: Connectors/src/OAuth/
    branch: dev
- name: samples-postgresql-efcore
  type: git
  source:
    uri: https://github.com/SteelToeOSS/Samples.git
    path: Connectors/src/PostgreEFCore/
    branch: dev
- name: samples-redis
  type: git
  source:
    uri: https://github.com/SteelToeOSS/Samples.git
    path: Connectors/src/Redis/
    branch: dev
- name: samples-security
  type: git
  source:
    uri: https://github.com/SteelToeOSS/Samples.git
    path: Security/src
    branch: dev
- name: samples-music-store
  type: git
  source:
    uri: https://github.com/SteelToeOSS/Samples.git
    path: MusicStore/src
    branch: ci-music
- name: connectors
  type: git
  source:
    uri: https://github.com/SteelToeOSS/Connectors.git
    branch: dev
- name: pcfdev-space
  type: cf-space-resource
  source:
    target: {{pcfdev2_target}}
    username: {{pcfdev2_username}}
    password: {{pcfdev2_password}}
    organization: integration

groups:
  - name: misc
    jobs:
      - cleanup-pcfdev
  - name: music-store
    jobs:
      - music-store-linux
      - music-store-windows
      - music-store-net451
  - name: postgresql
    jobs:
      - postgres-efcore-linux
      - postgres-efcore-windows
      - postgres-efcore-net451
      - postgres-linux
      - postgres-windows
      - postgres-net451
  - name: mysql
    jobs:
      - mysql-windows
      - mysql-ef6-windows
  - name: rabbit
    jobs:
      - rabbit-linux
      - rabbit-windows
      - rabbit-net451
  - name: oauth
    jobs:
      - oauth-linux
      - oauth-windows
      - oauth-net451
  - name: redis
    jobs:
      - redis-net451-windows
  - name: caching
    jobs:
      - caching-redis-net451-windows
  - name: config
    jobs:
      - config-windows
      - config-linux
      - config-net451
  - name: security
    jobs:
      - security-linux
      - security-windows
      - security-net451

jobs:
- name: cleanup-pcfdev
  plan:
  - task: remove-all-spaces
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: dgodd/cf-cli
      params:
        CF_TARGET: {{pcfdev2_target}}
        CF_USERNAME: {{pcfdev2_username}}
        CF_PASSWORD: {{pcfdev2_password}}
        CF_ORGANIZATION: integration
      run:
        path: sh
        args:
        - -ec
        - |
          cf login -a $CF_TARGET -u $CF_USERNAME -p $CF_PASSWORD --skip-ssl-validation -o system -s system
          set -x

          export SPACES=`cf curl "/v2/organizations?q=name%3A${CF_ORGANIZATION}&inline-relations-depth=1" | jq -r '.resources[0].entity.spaces|sort_by(.metadata.created_at)|reverse|.[].entity.name'`
          if [ -n "$SPACES" ]; then
            echo $SPACES | xargs -n1 cf delete-space -f
          fi

          export APPS=`cf curl '/v2/organizations?q=name%3Ap-spring-cloud-services&inline-relations-depth=2' | jq -r '.resources[].entity.spaces[].entity|select(.name|contains("instances"))|.apps[].entity.name'`
          if [ -n "$APPS" ]; then
            echo $APPS | xargs -n1 cf delete -f
          fi

- name: postgres-efcore-linux
  plan:
  - get: steeltoe-ci
  - get: connectors
    trigger: false
  - get: samples
    resource: samples-postgresql-efcore
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: create-service
      file: steeltoe-ci/tasks/create-service.yml
      params:
        CREATE_SERVICE: WhaleDB public myPostgres
    - task: publish
      file: steeltoe-ci/tasks/publish.yml
      params:
        SOURCE_DIR: samples/Connectors/src/PostgreEFCore/
        MANIFEST_YAML: manifest.yml
        FRAMEWORK: netcoreapp1.0
        RUNTIME: ubuntu.14.04-x64
    - task: push-app
      attempts: 2
      file: steeltoe-ci/tasks/push-app.yml
      params:
        STACK: cflinuxfs2
    - task: test-app
      attempts: 5
      file: steeltoe-ci/tasks/test-app.yml
      params:
        URL_PATH: /Home/PostgresData
        TEXT: <h3>Key2=Test Data 2
    ensure:
      task: delete-space
      file: steeltoe-ci/tasks/delete-space.yml

- name: postgres-efcore-windows
  plan:
  - get: steeltoe-ci
  - get: connectors
    trigger: false
  - get: samples
    resource: samples-postgresql-efcore
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: create-service
      file: steeltoe-ci/tasks/create-service.yml
      params:
        CREATE_SERVICE: WhaleDB public myPostgres
    - task: publish
      file: steeltoe-ci/tasks/publish.yml
      params:
        SOURCE_DIR: samples/Connectors/src/PostgreEFCore/
        MANIFEST_YAML: manifest-windows.yml
        FRAMEWORK: netcoreapp1.0
        RUNTIME: win7-x64
    - task: push-app
      attempts: 2
      file: steeltoe-ci/tasks/push-app.yml
      params:
        STACK: windows2012R2
    - task: test-app
      attempts: 5
      file: steeltoe-ci/tasks/test-app.yml
      params:
        URL_PATH: /Home/PostgresData
        TEXT: <h3>Key2=Test Data 2
    ensure:
      task: delete-space
      file: steeltoe-ci/tasks/delete-space.yml

- name: postgres-efcore-net451
  plan:
  - get: steeltoe-ci
  - get: connectors
    trigger: false
  - get: samples
    resource: samples-postgresql-efcore
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: create-service
      file: steeltoe-ci/tasks/create-service.yml
      params:
        CREATE_SERVICE: WhaleDB public myPostgres
    - task: publish
      file: steeltoe-ci/tasks/publish.yml
      params:
        SOURCE_DIR: samples/Connectors/src/PostgreEFCore/
        MANIFEST_YAML: manifest-windows.yml
        FRAMEWORK: net451
        RUNTIME: win7-x64
    - task: push-app
      attempts: 2
      file: steeltoe-ci/tasks/push-app.yml
      params:
        STACK: windows2012R2
    - task: test-app
      attempts: 5
      file: steeltoe-ci/tasks/test-app.yml
      params:
        URL_PATH: /Home/PostgresData
        TEXT: <h3>Key2=Test Data 2
    ensure:
      task: delete-space
      file: steeltoe-ci/tasks/delete-space.yml

- name: postgres-linux
  plan:
  - get: steeltoe-ci
  - get: connectors
    trigger: false
  - get: samples
    resource: samples-postgresql
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: create-service
      file: steeltoe-ci/tasks/create-service.yml
      params:
        CREATE_SERVICE: WhaleDB public myPostgres
    - task: publish
      file: steeltoe-ci/tasks/publish.yml
      params:
        SOURCE_DIR: samples/Connectors/src/PostgreSql/
        MANIFEST_YAML: manifest.yml
        FRAMEWORK: netcoreapp1.0
        RUNTIME: ubuntu.14.04-x64
    - task: push-app
      attempts: 2
      file: steeltoe-ci/tasks/push-app.yml
      params:
        STACK: cflinuxfs2
    - task: test-app
      attempts: 5
      file: steeltoe-ci/tasks/test-app.yml
      params:
        URL_PATH: /Home/PostgresData
        TEXT: <h3>Key1=Row1 Text
    ensure:
      task: delete-space
      file: steeltoe-ci/tasks/delete-space.yml

- name: postgres-windows
  plan:
  - get: steeltoe-ci
  - get: connectors
    trigger: false
  - get: samples
    resource: samples-postgresql
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: create-service
      file: steeltoe-ci/tasks/create-service.yml
      params:
        CREATE_SERVICE: WhaleDB public myPostgres
    - task: publish
      file: steeltoe-ci/tasks/publish.yml
      params:
        SOURCE_DIR: samples/Connectors/src/PostgreSql/
        MANIFEST_YAML: manifest-windows.yml
        FRAMEWORK: netcoreapp1.0
        RUNTIME: win7-x64
    - task: push-app
      attempts: 2
      file: steeltoe-ci/tasks/push-app.yml
      params:
        STACK: windows2012R2
    - task: test-app
      attempts: 5
      file: steeltoe-ci/tasks/test-app.yml
      params:
        URL_PATH: /Home/PostgresData
        TEXT: <h3>Key1=Row1 Text
    ensure:
      task: delete-space
      file: steeltoe-ci/tasks/delete-space.yml

- name: postgres-net451
  plan:
  - get: steeltoe-ci
  - get: connectors
    trigger: false
  - get: samples
    resource: samples-postgresql
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: create-service
      file: steeltoe-ci/tasks/create-service.yml
      params:
        CREATE_SERVICE: WhaleDB public myPostgres
    - task: publish
      file: steeltoe-ci/tasks/publish.yml
      params:
        SOURCE_DIR: samples/Connectors/src/PostgreSql/
        MANIFEST_YAML: manifest-windows.yml
        FRAMEWORK: net451
        RUNTIME: win7-x64
    - task: push-app
      attempts: 2
      file: steeltoe-ci/tasks/push-app.yml
      params:
        STACK: windows2012R2
    - task: test-app
      attempts: 5
      file: steeltoe-ci/tasks/test-app.yml
      params:
        URL_PATH: /Home/PostgresData
        TEXT: <h3>Key1=Row1 Text
    ensure:
      task: delete-space
      file: steeltoe-ci/tasks/delete-space.yml

- name: rabbit-linux
  plan:
  - get: steeltoe-ci
  - get: connectors
    trigger: false
  - get: samples
    resource: samples-rabbit
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: create-service
      file: steeltoe-ci/tasks/create-service.yml
      params:
        CREATE_SERVICE: p-rabbitmq standard myRabbitService
    - task: publish
      file: steeltoe-ci/tasks/publish.yml
      params:
        SOURCE_DIR: samples/Connectors/src/Rabbit/
        MANIFEST_YAML: manifest.yml
        FRAMEWORK: netcoreapp1.0
        RUNTIME: ubuntu.14.04-x64
    - task: push-app
      attempts: 2
      file: steeltoe-ci/tasks/push-app.yml
      params:
        STACK: cflinuxfs2
    - task: test-app
      attempts: 5
      file: steeltoe-ci/tasks/test-app.yml
      params:
        PRECOND: curl -k -X POST -F 'Message=Some exciting text' https://$URL/Rabbit/Send
        URL_PATH: /
        TEXT: <h3>Message=Some exciting text
    ensure:
      task: delete-space
      file: steeltoe-ci/tasks/delete-space.yml

- name: rabbit-windows
  plan:
  - get: steeltoe-ci
  - get: connectors
    trigger: false
  - get: samples
    resource: samples-rabbit
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: create-service
      file: steeltoe-ci/tasks/create-service.yml
      params:
        CREATE_SERVICE: p-rabbitmq standard myRabbitService
    - task: publish
      file: steeltoe-ci/tasks/publish.yml
      params:
        SOURCE_DIR: samples/Connectors/src/Rabbit/
        MANIFEST_YAML: manifest-windows.yml
        FRAMEWORK: netcoreapp1.0
        RUNTIME: win7-x64
    - task: push-app
      attempts: 2
      file: steeltoe-ci/tasks/push-app.yml
      params:
        STACK: windows2012R2
    - task: test-app
      attempts: 5
      file: steeltoe-ci/tasks/test-app.yml
      params:
        PRECOND: curl -k -X POST -F 'Message=Some exciting text' https://$URL/Rabbit/Send
        URL_PATH: /
        TEXT: <h3>Message=Some exciting text
    ensure:
      task: delete-space
      file: steeltoe-ci/tasks/delete-space.yml

- name: rabbit-net451
  plan:
  - get: steeltoe-ci
  - get: connectors
    trigger: false
  - get: samples
    resource: samples-rabbit
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: create-service
      file: steeltoe-ci/tasks/create-service.yml
      params:
        CREATE_SERVICE: p-rabbitmq standard myRabbitService
    - task: publish
      file: steeltoe-ci/tasks/publish.yml
      params:
        SOURCE_DIR: samples/Connectors/src/Rabbit/
        MANIFEST_YAML: manifest-windows.yml
        FRAMEWORK: net451
        RUNTIME: win7-x64
    - task: push-app
      attempts: 2
      file: steeltoe-ci/tasks/push-app.yml
      params:
        STACK: windows2012R2
    - task: test-app
      attempts: 5
      file: steeltoe-ci/tasks/test-app.yml
      params:
        PRECOND: curl -k -X POST -F 'Message=Some exciting text' https://$URL/Rabbit/Send
        URL_PATH: /
        TEXT: <h3>Message=Some exciting text
    ensure:
      task: delete-space
      file: steeltoe-ci/tasks/delete-space.yml

- name: mysql-windows
  plan:
  - get: steeltoe-ci
  - get: connectors
    trigger: false
  - get: samples
    resource: samples-mysql
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: create-service
      file: steeltoe-ci/tasks/create-service.yml
      params:
        CREATE_SERVICE: p-mysql 512mb myMySqlService
    - task: publish
      file: steeltoe-ci/tasks/publish.yml
      params:
        SOURCE_DIR: samples/Connectors/src/MySql/
        MANIFEST_YAML: manifest-windows.yml
        FRAMEWORK: net451
        RUNTIME: win7-x64
    - task: push-app
      attempts: 2
      file: steeltoe-ci/tasks/push-app.yml
      params:
        STACK: windows2012R2
    - task: test-app
      attempts: 5
      file: steeltoe-ci/tasks/test-app.yml
      params:
        URL_PATH: /Home/MySqlData
        TEXT: <h3>Key2=Row2 Text
    ensure:
      task: delete-space
      file: steeltoe-ci/tasks/delete-space.yml

- name: mysql-ef6-windows
  plan:
  - get: steeltoe-ci
  - get: connectors
    trigger: false
  - get: samples
    resource: samples-mysql-ef6
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: create-service
      file: steeltoe-ci/tasks/create-service.yml
      params:
        CREATE_SERVICE: p-mysql 512mb myMySqlService
    - task: publish
      file: steeltoe-ci/tasks/publish.yml
      params:
        SOURCE_DIR: samples/Connectors/src/MySql/
        MANIFEST_YAML: manifest-windows.yml
        FRAMEWORK: net451
        RUNTIME: win7-x64
    - task: push-app
      attempts: 2
      file: steeltoe-ci/tasks/push-app.yml
      params:
        STACK: windows2012R2
    - task: test-app
      attempts: 5
      file: steeltoe-ci/tasks/test-app.yml
      params:
        URL_PATH: /Home/MySqlData
        TEXT: <h3>Key1=Row1 Text
    ensure:
      task: delete-space
      file: steeltoe-ci/tasks/delete-space.yml

- name: oauth-linux
  plan:
  - get: steeltoe-ci
  - get: connectors
    trigger: false
  - get: samples
    resource: samples-oauth
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: create-service
      file: steeltoe-ci/tasks/create-service.yml
      params:
        CREATE_CUPS: 'myOAuthService -p {"client_id":"myTestApp","client_secret":"myTestApp","uri":"uaa://login.pcfdev.shoetree.io"}'
    - task: publish
      file: steeltoe-ci/tasks/publish.yml
      params:
        SOURCE_DIR: samples/Connectors/src/OAuth/
        MANIFEST_YAML: manifest.yml
        FRAMEWORK: netcoreapp1.0
        RUNTIME: ubuntu.14.04-x64
    - task: push-app
      attempts: 2
      file: steeltoe-ci/tasks/push-app.yml
      params:
        STACK: cflinuxfs2
    - task: test-app
      attempts: 5
      file: steeltoe-ci/tasks/test-app.yml
      params:
        URL_PATH: /Home/OAuthOptions
        TEXT: <h4>AccessTokenUrl = https://login.pcfdev.shoetree.io/oauth/token
    ensure:
      task: delete-space
      file: steeltoe-ci/tasks/delete-space.yml


- name: oauth-windows
  plan:
  - get: steeltoe-ci
  - get: connectors
    trigger: false
  - get: samples
    resource: samples-oauth
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: create-service
      file: steeltoe-ci/tasks/create-service.yml
      params:
        CREATE_CUPS: 'myOAuthService -p {"client_id":"myTestApp","client_secret":"myTestApp","uri":"uaa://login.pcfdev.shoetree.io"}'
    - task: publish
      file: steeltoe-ci/tasks/publish.yml
      params:
        SOURCE_DIR: samples/Connectors/src/OAuth/
        MANIFEST_YAML: manifest-windows.yml
        FRAMEWORK: netcoreapp1.0
        RUNTIME: win7-x64
    - task: push-app
      attempts: 2
      file: steeltoe-ci/tasks/push-app.yml
      params:
        STACK: windows2012R2
    - task: test-app
      attempts: 5
      file: steeltoe-ci/tasks/test-app.yml
      params:
        URL_PATH: /Home/OAuthOptions
        TEXT: <h4>AccessTokenUrl = https://login.pcfdev.shoetree.io/oauth/token
    ensure:
      task: delete-space
      file: steeltoe-ci/tasks/delete-space.yml

- name: oauth-net451
  plan:
  - get: steeltoe-ci
  - get: connectors
    trigger: false
  - get: samples
    resource: samples-oauth
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: create-service
      file: steeltoe-ci/tasks/create-service.yml
      params:
        CREATE_CUPS: 'myOAuthService -p {"client_id":"myTestApp","client_secret":"myTestApp","uri":"uaa://login.pcfdev.shoetree.io"}'
    - task: publish
      file: steeltoe-ci/tasks/publish.yml
      params:
        SOURCE_DIR: samples/Connectors/src/OAuth/
        MANIFEST_YAML: manifest-windows.yml
        FRAMEWORK: net451
        RUNTIME: win7-x64
    - task: push-app
      attempts: 2
      file: steeltoe-ci/tasks/push-app.yml
      params:
        STACK: windows2012R2
    - task: test-app
      attempts: 5
      file: steeltoe-ci/tasks/test-app.yml
      params:
        URL_PATH: /Home/OAuthOptions
        TEXT: <h4>AccessTokenUrl = https://login.pcfdev.shoetree.io/oauth/token
    ensure:
      task: delete-space
      file: steeltoe-ci/tasks/delete-space.yml

- name: redis-net451-windows
  plan:
  - get: steeltoe-ci
  - get: connectors
    trigger: false
  - get: samples
    resource: samples-redis
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: create-service
      file: steeltoe-ci/tasks/create-service.yml
      params:
        CREATE_SERVICE: p-redis shared-vm myRedisService
    - task: publish
      file: steeltoe-ci/tasks/publish.yml
      params:
        SOURCE_DIR: samples/Connectors/src/Redis/
        MANIFEST_YAML: manifest-windows.yml
        FRAMEWORK: net451
        RUNTIME: win7-x64
    - task: push-app
      attempts: 2
      file: steeltoe-ci/tasks/push-app.yml
      params:
        STACK: windows2012R2
    - task: test-app
      attempts: 5
      file: steeltoe-ci/tasks/test-app.yml
      params:
        URL_PATH: /Home/CacheData
        TEXT: <h3>Key1=Key1Value
    ensure:
      task: delete-space
      file: steeltoe-ci/tasks/delete-space.yml

- name: caching-redis-net451-windows
  plan:
  - get: steeltoe-ci
  - get: connectors
    trigger: false
  - get: samples
    resource: samples-caching
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: create-service
      file: steeltoe-ci/tasks/create-service.yml
      params:
        CREATE_SERVICE: p-redis shared-vm myRedisService
    - task: publish
      file: steeltoe-ci/tasks/publish.yml
      params:
        SOURCE_DIR: samples/Caching/src/RedisCloudFoundry/
        MANIFEST_YAML: manifest-windows.yml
        FRAMEWORK: net451
        RUNTIME: win7-x64
    - task: push-app
      attempts: 2
      file: steeltoe-ci/tasks/push-app.yml
      params:
        STACK: windows2012R2
    - task: test-app
      attempts: 5
      file: steeltoe-ci/tasks/test-app.yml
      params:
        URL_PATH: /Home/CacheData
        TEXT: <h3>Key1=Key1Value
    ensure:
      task: delete-space
      file: steeltoe-ci/tasks/delete-space.yml

- name: config-windows
  plan:
  - get: steeltoe-ci
  - get: connectors
    trigger: false
  - get: samples
    resource: samples-config
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: create-service
      file: steeltoe-ci/tasks/create-service.yml
      params:
        CREATE_SERVICE: p-config-server standard myConfigServer -c ./samples/Configuration/src/AspDotNetCore/SimpleCloudFoundry/config-server.json
    - task: publish
      file: steeltoe-ci/tasks/publish.yml
      params:
        SOURCE_DIR: samples/Configuration/src/AspDotNetCore/SimpleCloudFoundry
        MANIFEST_YAML: manifest-windows.yml
        FRAMEWORK: netcoreapp1.0
        RUNTIME: win7-x64
    - task: push-app
      attempts: 2
      file: steeltoe-ci/tasks/push-app.yml
      params:
        STACK: windows2012R2
        APPNAME: foo
    - task: test-app
      attempts: 5
      file: steeltoe-ci/tasks/test-app.yml
      params:
        URL_PATH: /Home/ConfigServer
        TEXT: <h4>Property info.description=Spring Cloud Samples
    ensure:
      task: delete-space
      file: steeltoe-ci/tasks/delete-space.yml

- name: config-linux
  plan:
  - get: steeltoe-ci
  - get: connectors
    trigger: false
  - get: samples
    resource: samples-config
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: create-service
      file: steeltoe-ci/tasks/create-service.yml
      params:
        CREATE_SERVICE: p-config-server standard myConfigServer -c ./samples/Configuration/src/AspDotNetCore/SimpleCloudFoundry/config-server.json
    - task: publish
      file: steeltoe-ci/tasks/publish.yml
      params:
        SOURCE_DIR: samples/Configuration/src/AspDotNetCore/SimpleCloudFoundry
        MANIFEST_YAML: manifest.yml
        FRAMEWORK: netcoreapp1.0
        RUNTIME: ubuntu.14.04-x64
    - task: push-app
      attempts: 2
      file: steeltoe-ci/tasks/push-app.yml
      params:
        STACK: cflinuxfs2
        APPNAME: foo
    - task: test-app
      attempts: 5
      file: steeltoe-ci/tasks/test-app.yml
      params:
        URL_PATH: /Home/ConfigServer
        TEXT: <h4>Property bar=spam
    ensure:
      task: delete-space
      file: steeltoe-ci/tasks/delete-space.yml

- name: config-net451
  plan:
  - get: steeltoe-ci
  - get: connectors
    trigger: false
  - get: samples
    resource: samples-config
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: create-service
      file: steeltoe-ci/tasks/create-service.yml
      params:
        CREATE_SERVICE: p-config-server standard myConfigServer -c ./samples/Configuration/src/AspDotNet4/SimpleCloudFoundry/config-server.json
    - task: publish
      file: steeltoe-ci/tasks/publish.yml
      params:
        SOURCE_DIR: samples/Configuration/src/AspDotNet4/SimpleCloudFoundry
        MANIFEST_YAML: manifest.yml
        FRAMEWORK: net451
        RUNTIME: win7-x64
    - task: push-app
      attempts: 2
      file: steeltoe-ci/tasks/push-app.yml
      params:
        STACK: windows2012R2
        APPNAME: foo
    - task: test-app
      attempts: 5
      file: steeltoe-ci/tasks/test-app.yml
      params:
        URL_PATH: /Home/ConfigServer
        TEXT: <h4>Property info.description=Spring Cloud Samples
    ensure:
      task: delete-space
      file: steeltoe-ci/tasks/delete-space.yml

- name: security-linux
  plan:
  - get: steeltoe-ci
  - get: connectors
    trigger: false
  - get: samples
    resource: samples-security
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: setup-uaa
      file: steeltoe-ci/tasks/setup-uaa.yml
    - task: create-service
      file: steeltoe-ci/tasks/create-service.yml
      params:
        CREATE_CUPS: 'myOAuthService -p {"client_id":"${SPACE}TestApp","client_secret":"${SPACE}TestApp","uri":"uaa://login.pcfdev.shoetree.io"}'
    - aggregate:
      - do:
        - task: publish-signon
          file: steeltoe-ci/tasks/publish.yml
          output_mapping: {publish: publish_signon}
          params:
            SOURCE_DIR: samples/Security/src/CloudFoundrySingleSignon
            MANIFEST_YAML: manifest.yml
            FRAMEWORK: netcoreapp1.0
            RUNTIME: ubuntu.14.04-x64
        - task: push-signon
          attempts: 2
          file: steeltoe-ci/tasks/push-app.yml
          input_mapping: {publish: publish_signon}
          params:
            STACK: cflinuxfs2
            APPNAME: single-signon
      - do:
        - task: publish-jwtauth
          file: steeltoe-ci/tasks/publish.yml
          output_mapping: {publish: publish_jwtauth}
          params:
            SOURCE_DIR: samples/Security/src/CloudFoundryJwtAuthentication
            MANIFEST_YAML: manifest.yml
            FRAMEWORK: netcoreapp1.0
            RUNTIME: ubuntu.14.04-x64
        - task: push-jwtauth
          attempts: 2
          file: steeltoe-ci/tasks/push-app.yml
          input_mapping: {publish: publish_jwtauth}
          params:
            STACK: cflinuxfs2
            APPNAME: jwtauth
    - task: test-app
      attempts: 5
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: dgodd/ruby
        inputs:
        - name: steeltoe-ci
        - name: cf-space
        run:
          path: sh
          args:
          - -euxc
          - |
            export SPACE=`cat cf-space/name`
            ./steeltoe-ci/scripts/test-security.rb
    ensure:
      do:
        - task: teardown-uaa
          file: steeltoe-ci/tasks/teardown-uaa.yml
        - task: delete-space
          file: steeltoe-ci/tasks/delete-space.yml

- name: security-windows
  plan:
  - get: steeltoe-ci
  - get: connectors
    trigger: false
  - get: samples
    resource: samples-security
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: setup-uaa
      file: steeltoe-ci/tasks/setup-uaa.yml
    - task: create-service
      file: steeltoe-ci/tasks/create-service.yml
      params:
        CREATE_CUPS: 'myOAuthService -p {"client_id":"${SPACE}TestApp","client_secret":"${SPACE}TestApp","uri":"uaa://login.pcfdev.shoetree.io"}'
    - aggregate:
      - do:
        - task: publish-signon
          file: steeltoe-ci/tasks/publish.yml
          output_mapping: {publish: publish_signon}
          params:
            SOURCE_DIR: samples/Security/src/CloudFoundrySingleSignon
            MANIFEST_YAML: manifest-windows.yml
            FRAMEWORK: netcoreapp1.0
            RUNTIME: win7-x64
        - task: push-signon
          attempts: 2
          file: steeltoe-ci/tasks/push-app.yml
          input_mapping: {publish: publish_signon}
          params:
            STACK: windows2012R2
            APPNAME: single-signon
      - do:
        - task: publish-jwtauth
          file: steeltoe-ci/tasks/publish.yml
          output_mapping: {publish: publish_jwtauth}
          params:
            SOURCE_DIR: samples/Security/src/CloudFoundryJwtAuthentication
            MANIFEST_YAML: manifest-windows.yml
            FRAMEWORK: netcoreapp1.0
            RUNTIME: win7-x64
        - task: push-jwtauth
          attempts: 2
          file: steeltoe-ci/tasks/push-app.yml
          input_mapping: {publish: publish_jwtauth}
          params:
            STACK: windows2012R2
            APPNAME: jwtauth
    - task: test-app
      attempts: 5
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: dgodd/ruby
        inputs:
        - name: steeltoe-ci
        - name: cf-space
        run:
          path: sh
          args:
          - -euxc
          - |
            export SPACE=`cat cf-space/name`
            ./steeltoe-ci/scripts/test-security.rb
    ensure:
      do:
        - task: teardown-uaa
          file: steeltoe-ci/tasks/teardown-uaa.yml
        - task: delete-space
          file: steeltoe-ci/tasks/delete-space.yml

- name: security-net451
  plan:
  - get: steeltoe-ci
  - get: connectors
    trigger: false
  - get: samples
    resource: samples-security
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: setup-uaa
      file: steeltoe-ci/tasks/setup-uaa.yml
    - task: create-service
      file: steeltoe-ci/tasks/create-service.yml
      params:
        CREATE_CUPS: 'myOAuthService -p {"client_id":"${SPACE}TestApp","client_secret":"${SPACE}TestApp","uri":"uaa://login.pcfdev.shoetree.io"}'
    - aggregate:
      - do:
        - task: publish-signon
          file: steeltoe-ci/tasks/publish.yml
          output_mapping: {publish: publish_signon}
          params:
            SOURCE_DIR: samples/Security/src/CloudFoundrySingleSignon
            MANIFEST_YAML: manifest-windows.yml
            FRAMEWORK: net451
            RUNTIME: win7-x64
        - task: push-signon
          attempts: 2
          file: steeltoe-ci/tasks/push-app.yml
          input_mapping: {publish: publish_signon}
          params:
            STACK: windows2012R2
            APPNAME: single-signon
      - do:
        - task: publish-jwtauth
          file: steeltoe-ci/tasks/publish.yml
          output_mapping: {publish: publish_jwtauth}
          params:
            SOURCE_DIR: samples/Security/src/CloudFoundryJwtAuthentication
            MANIFEST_YAML: manifest-windows.yml
            FRAMEWORK: net451
            RUNTIME: win7-x64
        - task: push-jwtauth
          attempts: 2
          file: steeltoe-ci/tasks/push-app.yml
          input_mapping: {publish: publish_jwtauth}
          params:
            STACK: windows2012R2
            APPNAME: jwtauth
    - task: test-app
      attempts: 5
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: dgodd/ruby
        inputs:
        - name: steeltoe-ci
        - name: cf-space
        run:
          path: sh
          args:
          - -euxc
          - |
            export SPACE=`cat cf-space/name`
            ./steeltoe-ci/scripts/test-security.rb
    ensure:
      do:
        - task: teardown-uaa
          file: steeltoe-ci/tasks/teardown-uaa.yml
        - task: delete-space
          file: steeltoe-ci/tasks/delete-space.yml

- name: music-store-linux
  plan:
  - get: steeltoe-ci
  - get: samples
    resource: samples-music-store
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: create-cloudfoundry-services
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: dgodd/cf-cli
        inputs:
        - name: cf-space
        - name: samples
        run:
          path: sh
          args:
          - -euxc
          - |
            ./cf-space/login
            cd samples/MusicStore
            cat createCloudFoundryServices.sh | sed 's/p-mysql pre-existing-plan/WhaleDB public/' | sh
    - aggregate:
      - do:
        - task: publish-MusicStoreService
          file: steeltoe-ci/tasks/publish.yml
          output_mapping: {publish: publish_musicstoreservice}
          params:
            SOURCE_DIR: samples/MusicStore/src/MusicStoreService
            MANIFEST_YAML: manifest.yml
            FRAMEWORK: netcoreapp1.0
            RUNTIME: ubuntu.14.04-x64
        - task: push-MusicStoreService
          attempts: 2
          file: steeltoe-ci/tasks/push-app.yml
          input_mapping: {publish: publish_musicstoreservice}
          params:
            STACK: cflinuxfs2
            APPNAME: musicstore
      - do:
        - task: publish-MusicStoreUI
          file: steeltoe-ci/tasks/publish.yml
          output_mapping: {publish: publish_musicstoreui}
          params:
            SOURCE_DIR: samples/MusicStore/src/MusicStoreUI
            MANIFEST_YAML: manifest.yml
            FRAMEWORK: netcoreapp1.0
            RUNTIME: ubuntu.14.04-x64
        - task: push-MusicStoreUI
          attempts: 2
          file: steeltoe-ci/tasks/push-app.yml
          input_mapping: {publish: publish_musicstoreui}
          params:
            STACK: cflinuxfs2
            APPNAME: musicui
      - do:
        - task: publish-OrderService
          file: steeltoe-ci/tasks/publish.yml
          output_mapping: {publish: publish_orderservice}
          params:
            SOURCE_DIR: samples/MusicStore/src/OrderService
            MANIFEST_YAML: manifest.yml
            FRAMEWORK: netcoreapp1.0
            RUNTIME: ubuntu.14.04-x64
        - task: push-OrderService
          attempts: 2
          file: steeltoe-ci/tasks/push-app.yml
          input_mapping: {publish: publish_orderservice}
          params:
            STACK: cflinuxfs2
            APPNAME: orderprocessing
      - do:
        - task: publish-ShoppingCartService
          file: steeltoe-ci/tasks/publish.yml
          output_mapping: {publish: publish_shoppingcartservice}
          params:
            SOURCE_DIR: samples/MusicStore/src/ShoppingCartService
            MANIFEST_YAML: manifest.yml
            FRAMEWORK: netcoreapp1.0
            RUNTIME: ubuntu.14.04-x64
        - task: push-ShoppingCartService
          attempts: 2
          file: steeltoe-ci/tasks/push-app.yml
          input_mapping: {publish: publish_shoppingcartservice}
          params:
            STACK: cflinuxfs2
            APPNAME: shoppingcart
    - task: test-app
      attempts: 5
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: dgodd/ruby
        inputs:
        - name: steeltoe-ci
        - name: cf-space
        run:
          path: sh
          args:
          - -euxc
          - |
            export SPACE=`cat cf-space/name`
            ./steeltoe-ci/scripts/test-musicstore.rb
  ensure:
    task: delete-space
    file: steeltoe-ci/tasks/delete-space.yml

- name: music-store-windows
  plan:
  - get: steeltoe-ci
  - get: samples
    resource: samples-music-store
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: create-cloudfoundry-services
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: dgodd/cf-cli
        inputs:
        - name: cf-space
        - name: samples
        run:
          path: sh
          args:
          - -euxc
          - |
            ./cf-space/login
            cd samples/MusicStore
            cat createCloudFoundryServices.sh | sed 's/p-mysql pre-existing-plan/WhaleDB public/' | sh
    - aggregate:
      - do:
        - task: publish-MusicStoreService
          file: steeltoe-ci/tasks/publish.yml
          output_mapping: {publish: publish_musicstoreservice}
          params:
            SOURCE_DIR: samples/MusicStore/src/MusicStoreService
            MANIFEST_YAML: manifest-windows.yml
            FRAMEWORK: netcoreapp1.0
            RUNTIME: win7-x64
        - task: push-MusicStoreService
          attempts: 2
          file: steeltoe-ci/tasks/push-app.yml
          input_mapping: {publish: publish_musicstoreservice}
          params:
            STACK: windows2012R2
            APPNAME: musicstore
      - do:
        - task: publish-MusicStoreUI
          file: steeltoe-ci/tasks/publish.yml
          output_mapping: {publish: publish_musicstoreui}
          params:
            SOURCE_DIR: samples/MusicStore/src/MusicStoreUI
            MANIFEST_YAML: manifest-windows.yml
            FRAMEWORK: netcoreapp1.0
            RUNTIME: win7-x64
        - task: push-MusicStoreUI
          attempts: 2
          file: steeltoe-ci/tasks/push-app.yml
          input_mapping: {publish: publish_musicstoreui}
          params:
            STACK: windows2012R2
            APPNAME: musicui
      - do:
        - task: publish-OrderService
          file: steeltoe-ci/tasks/publish.yml
          output_mapping: {publish: publish_orderservice}
          params:
            SOURCE_DIR: samples/MusicStore/src/OrderService
            MANIFEST_YAML: manifest-windows.yml
            FRAMEWORK: netcoreapp1.0
            RUNTIME: win7-x64
        - task: push-OrderService
          attempts: 2
          file: steeltoe-ci/tasks/push-app.yml
          input_mapping: {publish: publish_orderservice}
          params:
            STACK: windows2012R2
            APPNAME: orderprocessing
      - do:
        - task: publish-ShoppingCartService
          file: steeltoe-ci/tasks/publish.yml
          output_mapping: {publish: publish_shoppingcartservice}
          params:
            SOURCE_DIR: samples/MusicStore/src/ShoppingCartService
            MANIFEST_YAML: manifest-windows.yml
            FRAMEWORK: netcoreapp1.0
            RUNTIME: win7-x64
        - task: push-ShoppingCartService
          attempts: 2
          file: steeltoe-ci/tasks/push-app.yml
          input_mapping: {publish: publish_shoppingcartservice}
          params:
            STACK: windows2012R2
            APPNAME: shoppingcart
    - task: test-app
      attempts: 5
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: dgodd/ruby
        inputs:
        - name: steeltoe-ci
        - name: cf-space
        run:
          path: sh
          args:
          - -euxc
          - |
            export SPACE=`cat cf-space/name`
            ./steeltoe-ci/scripts/test-musicstore.rb
  # ensure:
    # task: delete-space
    # file: steeltoe-ci/tasks/delete-space.yml

- name: music-store-net451
  plan:
  - get: steeltoe-ci
  - get: samples
    resource: samples-music-store
    trigger: false
  - put: cf-space
    resource: pcfdev-space
  - do:
    - task: create-cloudfoundry-services
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: dgodd/cf-cli
        inputs:
        - name: cf-space
        - name: samples
        run:
          path: sh
          args:
          - -euxc
          - |
            ./cf-space/login
            cd samples/MusicStore
            cat createCloudFoundryServices.sh | sed 's/p-mysql pre-existing-plan/p-mysql 512mb/' | sh
    - aggregate:
      - do:
        - task: publish-MusicStoreService
          file: steeltoe-ci/tasks/publish.yml
          output_mapping: {publish: publish_musicstoreservice}
          params:
            SOURCE_DIR: samples/MusicStore/src/MusicStoreService
            MANIFEST_YAML: manifest-windows.yml
            FRAMEWORK: net451
            RUNTIME: win7-x64
        - task: push-MusicStoreService
          attempts: 2
          file: steeltoe-ci/tasks/push-app.yml
          input_mapping: {publish: publish_musicstoreservice}
          params:
            STACK: windows2012R2
            APPNAME: musicstore
      - do:
        - task: publish-MusicStoreUI
          file: steeltoe-ci/tasks/publish.yml
          output_mapping: {publish: publish_musicstoreui}
          params:
            SOURCE_DIR: samples/MusicStore/src/MusicStoreUI
            MANIFEST_YAML: manifest-windows.yml
            FRAMEWORK: net451
            RUNTIME: win7-x64
        - task: push-MusicStoreUI
          attempts: 2
          file: steeltoe-ci/tasks/push-app.yml
          input_mapping: {publish: publish_musicstoreui}
          params:
            STACK: windows2012R2
            APPNAME: musicui
      - do:
        - task: publish-OrderService
          file: steeltoe-ci/tasks/publish.yml
          output_mapping: {publish: publish_orderservice}
          params:
            SOURCE_DIR: samples/MusicStore/src/OrderService
            MANIFEST_YAML: manifest-windows.yml
            FRAMEWORK: net451
            RUNTIME: win7-x64
        - task: push-OrderService
          attempts: 2
          file: steeltoe-ci/tasks/push-app.yml
          input_mapping: {publish: publish_orderservice}
          params:
            STACK: windows2012R2
            APPNAME: orderprocessing
      - do:
        - task: publish-ShoppingCartService
          file: steeltoe-ci/tasks/publish.yml
          output_mapping: {publish: publish_shoppingcartservice}
          params:
            SOURCE_DIR: samples/MusicStore/src/ShoppingCartService
            MANIFEST_YAML: manifest-windows.yml
            FRAMEWORK: net451
            RUNTIME: win7-x64
        - task: push-ShoppingCartService
          attempts: 2
          file: steeltoe-ci/tasks/push-app.yml
          input_mapping: {publish: publish_shoppingcartservice}
          params:
            STACK: windows2012R2
            APPNAME: shoppingcart
    - task: test-app
      attempts: 5
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: dgodd/ruby
        inputs:
        - name: steeltoe-ci
        - name: cf-space
        run:
          path: sh
          args:
          - -euxc
          - |
            export SPACE=`cat cf-space/name`
            ./steeltoe-ci/scripts/test-musicstore.rb
  # ensure:
    # task: delete-space
    # file: steeltoe-ci/tasks/delete-space.yml
